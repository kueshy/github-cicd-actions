# .github/workflows/ci-cd.yml

name: CI/CD Pipeline

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master ]

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/ci-cd-pipeline
  JAVA_VERSION: '17'
  MAVEN_VERSION: '3.9.5'

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Build with Maven
        run: mvn clean compile -DskipTests

      - name: Run unit tests
        run: mvn test

      - name: Run integration tests
        run: mvn verify -DskipUnitTests

      - name: Generate test coverage
        run: mvn jacoco:report

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./target/site/jacoco/jacoco.xml
          fail_ci_if_error: false

      - name: Package application
        run: mvn package -DskipTests

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-jar
          path: target/*.jar

#  code-quality:
#    name: Code Quality Analysis
#    runs-on: ubuntu-latest
#    needs: build-and-test
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#        with:
#          fetch-depth: 0
#
#      - name: Set up JDK
#        uses: actions/setup-java@v4
#        with:
#          java-version: ${{ env.JAVA_VERSION }}
#          distribution: 'temurin'
#          cache: maven
#
#      - name: SonarCloud Scan
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#        run: |
#          mvn sonar:sonar \
#            -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
#            -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
#            -Dsonar.host.url=https://sonarcloud.io

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

      - name: OWASP Dependency Check
        run: mvn dependency-check:check

  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [build-and-test]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: app-jar
          path: target/

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Scan Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

#  deploy-staging:
#    name: Deploy to Staging
#    runs-on: ubuntu-latest
#    needs: build-docker
#    if: github.ref == 'refs/heads/develop'
#    environment:
#      name: staging
#      url: https://staging.ams-health.com
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Deploy to Docker Swarm/Compose
#        uses: appleboy/ssh-action@v1.0.0
#        with:
#          host: ${{ secrets.STAGING_HOST }}
#          username: ${{ secrets.STAGING_USERNAME }}
#          key: ${{ secrets.STAGING_SSH_KEY }}
#          script: |
#            cd /opt/ams-health
#            docker-compose pull
#            docker-compose up -d
#            docker system prune -f
#
#      - name: Health check
#        run: |
#          sleep 30
#          curl -f ${{ secrets.STAGING_URL }}/actuator/health || exit 1
#
#      - name: Notify Slack
#        uses: 8398a7/action-slack@v3
#        with:
#          status: ${{ job.status }}
#          text: 'Deployment to Staging: ${{ job.status }}'
#          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
#        if: always()
#
#  deploy-production:
#    name: Deploy to Production
#    runs-on: ubuntu-latest
#    needs: build-docker
#    if: github.ref == 'refs/heads/main'
#    environment:
#      name: production
#      url: https://ams-health.com
#
#    steps:
#      - name: Checkout code
#        uses: actions/checkout@v4
#
#      - name: Deploy to Kubernetes
#        uses: azure/k8s-deploy@v4
#        with:
#          manifests: |
#            k8s/deployment.yaml
#            k8s/service.yaml
#          images: |
#            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
#          kubectl-version: 'latest'
#
#      - name: Wait for rollout
#        run: |
#          kubectl rollout status deployment/ams-health -n production --timeout=5m
#
#      - name: Smoke tests
#        run: |
#          sleep 30
#          curl -f https://ams-health.com/actuator/health || exit 1
#
#      - name: Notify team
#        uses: 8398a7/action-slack@v3
#        with:
#          status: ${{ job.status }}
#          text: 'Production Deployment: ${{ job.status }}'
#          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
#        if: always()
